# syntax=docker/dockerfile:1.4
# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build api`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t api`.
FROM docker.io/node:lts-alpine

ENV HOST=0.0.0.0
ENV PORT=1500

WORKDIR /app

RUN addgroup --system api && \
  adduser --system -G api api

RUN echo $(ls ./)
COPY dist/apps/api api
RUN chown -R api:api .

# You can remove this install step if you build with `--bundle` option.
# The bundled output will include external dependencies.
# ensure buildkit secret is used and npm/yarn will actually authenticate on tarball downloads
RUN --mount=type=secret,id=npmrc,required=false \
  sh -euxc '\
    # If buildkit mounted a secret, copy it to root and make sure it contains always-auth
    if [ -f /run/secrets/npmrc ]; then \
      cp /run/secrets/npmrc /root/.npmrc && chmod 600 /root/.npmrc; \
      # ensure always-auth exists (append only if missing) \
      if ! grep -q "^always-auth=" /root/.npmrc 2>/dev/null; then \
        echo "always-auth=true" >> /root/.npmrc; \
      fi; \
      # Extract token without printing it and set it into npm config (userconfig=/root/.npmrc) \
      TOKEN=$(sed -n \"s@.*_authToken=\\(.*\\)@\\1@p\" /root/.npmrc || true); \
      if [ -n \"$TOKEN\" ]; then \
        npm config set //npm.pkg.github.com/:_authToken \"$TOKEN\" --userconfig=/root/.npmrc >/dev/null 2>&1 || true; \
        npm config set always-auth true --userconfig=/root/.npmrc >/dev/null 2>&1 || true; \
      fi; \
      # Copy into project dir so yarn will definitely read it for tarball downloads \
      cp /root/.npmrc api/.npmrc || true; \
    fi; \
    # Ensure yarn/npm use this config at runtime \
    export NPM_CONFIG_USERCONFIG=/root/.npmrc; \
    export NPM_CONFIG_ALWAYS_AUTH=true; \
    # Run install and remove credentials immediately after use \
    yarn --cwd api --omit=dev -f install; \
    rm -f /root/.npmrc api/.npmrc || true'

CMD [ "node", "api" ]
